{% extends "base_standard.html" %}
{% load partials %}

{% block title %}
  <title>Contributors - {{ PROJECT_NAME }}</title>
{% endblock %}

{% block page_title %}{{ PROJECT_OWNER }} Contributors{% endblock %}
{% block page_subtitle %}Browse and search all contributors in the system{% endblock %}

{% block header_badge_content %}
  <i class="fas fa-users mr-1"></i>
  {{ page_obj.paginator.count }} Contributors
{% endblock %}

{% block main_content %}
<div class="space-y-6">
  <!-- Search Card -->
  <div class="stat-card">
    <div class="flex items-center gap-2 mb-4">
      <i class="fas fa-search text-primary"></i>
      <h2 class="text-xl font-bold">Search Contributors</h2>
    </div>

    <!-- ✅ HTMX Search -->
    <form method="get"
          hx-get="."
          hx-target="#results-container"
          hx-select="#results-container > *"
          hx-swap="innerHTML transition:true"
          hx-push-url="true"
          hx-trigger="input changed delay:400ms"
          class="flex flex-col sm:flex-row gap-4 items-start sm:items-end">

        <div class="flex-1 w-full">
          <label class="label">
            <span class="label-text font-semibold">Search by name or handle</span>
          </label>
          <div class="relative">
            <input type="text"
                  name="q"
                  value="{{ search_query }}"
                  placeholder="Enter contributor name, GitHub username, or other handles..."
                  class="input input-bordered w-full pr-10 text-base">

            <!-- Loading spinner -->
            <span class="loading loading-spinner loading-sm absolute right-3 top-1/2 -translate-y-1/2 opacity-0"
                  id="search-spinner"
                  hx-indicator>
            </span>
          </div>
        </div>

        <div class="flex gap-2 w-full sm:w-auto">
          <button type="submit" class="btn btn-primary flex-1 sm:flex-none">
            <i class="fas fa-search mr-2"></i>
            Search
          </button>

          {% if search_query %}
            <a href="." class="btn btn-outline flex-1 sm:flex-none">
              <i class="fas fa-times mr-2"></i>
              Clear
            </a>
          {% endif %}
        </div>
    </form>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Results Column -->
    <div class="lg:col-span-2">
      <div id="results-container">
        {% partial results_partial %}
      </div>
    </div>

    <!-- Sidebar Column -->
    <div class="space-y-6">
      <!-- Quick Actions -->
      <div class="stat-card">
        <div class="flex items-center gap-2 mb-4">
          <i class="fas fa-rocket text-accent"></i>
          <h2 class="text-xl font-bold">Quick Actions</h2>
        </div>

        <div class="space-y-3">
          <a href="{% url 'index' %}" class="btn btn-outline justify-start w-full">
            <i class="fas fa-arrow-left mr-2"></i>
            Back to Home
          </a>
          <a href="{% url 'cycles' %}" class="btn btn-outline justify-start w-full">
            <i class="fas fa-sync-alt mr-2"></i>
            View Cycles
          </a>
          <a href="{% url 'issues' %}" class="btn btn-outline justify-start w-full">
            <i class="fas fa-tasks mr-2"></i>
            Browse Issues
          </a>
          {% if user.is_superuser %}
          <a href="{% url 'unconfirmed_contributions' %}" class="btn btn-outline justify-start w-full">
            <i class="fas fa-clock mr-2"></i>
            Unconfirmed
          </a>
          {% endif %}
        </div>
      </div>

      <!-- Stats Card -->
      <div class="stat-card">
        <div class="flex items-center gap-2 mb-4">
          <i class="fas fa-chart-bar text-info"></i>
          <h2 class="text-xl font-bold">Contributors Stats</h2>
        </div>

        <div class="space-y-4">
          <div class="flex justify-between items-center">
            <span class="text-base-content/70">Total Contributors</span>
            <span class="font-semibold text-primary">{{ page_obj.paginator.count }}</span>
          </div>

          <div class="flex justify-between items-center">
            <span class="text-base-content/70">Per Page</span>
            <span class="font-semibold text-secondary">{{ paginate_by|default:20 }}</span>
          </div>

          <div class="flex justify-between items-center">
            <span class="text-base-content/70">Pages</span>
            <span class="font-semibold text-accent">{{ paginator.num_pages|default:1 }}</span>
          </div>

          <div class="flex justify-between items-center">
            <span class="text-base-content/70">Current Page</span>
            <span class="font-semibold text-success">{{ page_obj.number }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% partialdef results_partial %}
  <!-- Search Results Info -->
  {% if search_query and contributor_list %}
    <div class="stat-card bg-info/5 border-info/20">
      <div class="flex items-center gap-3">
        <i class="fas fa-info-circle text-info text-xl"></i>
        <div>
          <h3 class="font-semibold text-info">Search Results</h3>
          <p class="text-base-content/80">
            Found {{ page_obj.paginator.count }} contributor(s) for "<strong>{{ search_query }}</strong>"
          </p>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Contributors List -->
  <div class="stat-card">
    <div class="flex items-center gap-2 mb-6">
      <i class="fas fa-list text-primary"></i>
      <h2 class="text-xl font-bold">
        {% if search_query %}
          Search Results
        {% else %}
          All Contributors
        {% endif %}
      </h2>
    </div>

    {% if contributor_list %}
      <div class="space-y-4">
        {% for contributor in contributor_list %}
        <div class="flex items-center justify-between p-4 bg-base-200 rounded-lg hover:bg-base-300 transition-colors group">
          <div class="flex items-center gap-4">
            <div class="p-3 rounded-lg bg-primary/10 text-primary">
              <i class="fas fa-user"></i>
            </div>
            <div>
              <a class="link link-accent text-xl font-semibold hover:no-underline" href="{{ contributor.get_absolute_url }}">
                {{ contributor.info }}
              </a>
              {% if contributor.prefetched_handles %}
              <div class="flex items-center gap-3 mt-1">
                {% for handle in contributor.prefetched_handles|slice:":3" %}
                <span class="badge badge-outline badge-sm">
                  <i class="fab fa-{{ handle.platform.name|lower }} mr-1"></i>
                  {{ handle.handle }}
                </span>
                {% endfor %}
                {% if contributor.prefetched_handles|length > 3 %}
                <span class="badge badge-ghost badge-sm">
                  +{{ contributor.prefetched_handles|length|add:"-3" }} more
                </span>
                {% endif %}
              </div>
              {% endif %}
            </div>
          </div>
          <div class="flex items-center gap-4">
            {% with rewards=contributor.total_rewards %}
            {% if rewards %}
            <div class="text-right">
              <div class="text-sm font-semibold text-base-content/70">Total Rewards</div>
              <div class="text-success font-bold">{{ rewards|floatformat:"g" }}</div>
            </div>
            {% endif %}
            {% endwith %}
            <i class="fas fa-chevron-right text-base-content/30 group-hover:text-base-content/60 transition-colors"></i>
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      {% if search_query %}
      <div class="text-center py-12">
        <i class="fas fa-search text-4xl text-base-content/30 mb-4"></i>
        <h3 class="text-xl font-semibold mb-2">No Contributors Found</h3>
        <p class="text-base-content/70 max-w-md mx-auto mb-6">
          No contributors found matching "<strong>{{ search_query }}</strong>". 
          Try adjusting your search terms or browse all contributors.
        </p>
        <a href="." class="btn btn-primary">
          <i class="fas fa-users mr-2"></i>
          View All Contributors
        </a>
      </div>
      {% else %}
      <div class="text-center py-12">
        <i class="fas fa-users text-4xl text-base-content/30 mb-4"></i>
        <h3 class="text-xl font-semibold mb-2">No Contributors Yet</h3>
        <p class="text-base-content/70 max-w-md mx-auto mb-6">
          There are no contributors registered in the database yet. 
          Contributors will appear here once they start making contributions.
        </p>
        <a href="{% url 'index' %}" class="btn btn-primary">
          <i class="fas fa-home mr-2"></i>
          Back to Home
        </a>
      </div>
      {% endif %}
    {% endif %}
  </div>

  <!-- ✅ HTMX-aware pagination -->
  {% if is_paginated %}
    <div class="stat-card">
      <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
        <div class="text-sm text-base-content/70">
          Showing <span class="font-semibold">{{ page_obj.start_index }}-{{ page_obj.end_index }}</span> 
          of <span class="font-semibold">{{ paginator.count }}</span> items
        </div>

        <div class="join">
          <!-- First Page -->
          {% if page_obj.has_previous %}
            <a hx-get="?{% if has_query_params %}{{ query_string }}&{% endif %}page=1"
              hx-target="#results-container"
              hx-select="#results-container > *"
              hx-swap="innerHTML transition:true"
              hx-push-url="true"
              class="join-item btn btn-sm btn-outline" title="First page">
              <i class="fas fa-angle-double-left"></i>
            </a>
          {% endif %}

          <!-- Previous Page -->
          {% if page_obj.has_previous %}
            <a hx-get="?{% if has_query_params %}{{ query_string }}&{% endif %}page={{ page_obj.previous_page_number }}"
              hx-target="#results-container"
              hx-select="#results-container > *"
              hx-swap="innerHTML transition:true"
              hx-push-url="true"
              class="join-item btn btn-sm btn-outline" title="Previous page">
              <i class="fas fa-angle-left"></i>
            </a>
          {% endif %}

          <!-- Current Page Indicator -->
          <div class="join-item btn btn-sm btn-outline btn-active pointer-events-none">
            Page {{ page_obj.number }} of {{ paginator.num_pages }}
          </div>

          <!-- Next Page -->
          {% if page_obj.has_next %}
            <a hx-get="?{% if has_query_params %}{{ query_string }}&{% endif %}page={{ page_obj.next_page_number }}"
              hx-target="#results-container"
              hx-select="#results-container > *"
              hx-swap="innerHTML transition:true"
              hx-push-url="true"
              class="join-item btn btn-sm btn-outline" title="Next page">
              <i class="fas fa-angle-right"></i>
            </a>
          {% endif %}

          <!-- Last Page -->
          {% if page_obj.has_next %}
            <a hx-get="?{% if has_query_params %}{{ query_string }}&{% endif %}page={{ paginator.num_pages }}"
              hx-target="#results-container"
              hx-select="#results-container > *"
              hx-swap="innerHTML transition:true"
              hx-push-url="true"
              class="join-item btn btn-sm btn-outline" title="Last page">
              <i class="fas fa-angle-double-right"></i>
            </a>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}
{% endpartialdef %}